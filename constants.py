import numpy as np
import jax.numpy as jnp

EPSILON       = 1e-12  # Small constant to avoid division by zero

# Tables from the AGAMA C++ snippet you provided (m = 0..12).
MMAX_HYPERGEOM = 12
HYPERGEOM_0 = jnp.array([
    [ 0.4529874071816636,-2.692539697590362,-6.480598406507461,-3.860216328610213,-2.609146033646615,
     -0.1909432553353492,-1.460299624021841,-0.01541563568408259,-1.115369096436195],
    [ 0.08938502676040028,-2.525406068615592,-3.802041706399501,-2.691157667804647,-2.741391856196645,
     -0.1823978151361306,-1.467764617695739,-0.01514303374682610,-1.116215391130251],
    [-0.01069787527041158,-1.537005620596391,-1.697345768635404,-0.3378529865322015,-1.983063657443297,
     -0.09488668216801367,-1.362931464322307,-0.00940689438170889,-1.093693723592968],
    [-0.01711490718455377,-0.6009550456991466, 3.394854752517220,36.72266736665577,-9.201204857656629,
      0.01516766397285159,-1.228118125014300,-0.005976086542472318,-1.080099304233194],
    [-0.02749247751103787,-0.3072229139612030, 5.687071537359105,55.96560640229840,-9.348637781981967,
      0.0007050923061239599,-1.068784792886700, 0.0006587322854650128, 0.1314557788692205],
    [ 0.006592755012603758, 0.1271086283761586,-20.85294538326066,368.2891340792655,17.55960611497124,
      0.01287836941499270,-2.119217276127404, 0.005841336094937430,-1.041259452130866],
    [ 0.02415357420175733, 0.2760551779728967, -8.304528092063684, 49.00778641555581, 5.706942819375404,
      0.0000135380497674,-1.077581157358874, 0.01898377989044321,-0.8802786435315881],
    [-0.4755438570635217,-15.23176265534132,-26.14525965096805, 22.72480434937186,-3.726962896593618,
     12.26068097538548, 2.374616974037387,-0.00001072561873862000,-0.9939982148579712],
    [-0.01778950682637795,-0.1621708071527029, -6.722812444954199, -3.605415274607454, 42.56877984182697,
    1763.410384466364, -40.89722407762218, 4.04152404e-8,-0.9643299106460461],
    [-0.01640040314046018,-0.1567441655078544, -6.696210685394554, 5.878476915868881,-15.59083749781898,
     297.2840667256496, 18.02878411264815,-1.6468589e-9,-0.9155934138921334],
    [-0.04537030719843308,-0.3438471580930914, -5.110748703261416, 4.979640874599663, -4.697175985956599,
      33.93946493242602, 5.914298150113606, 9.7752486955e-9, 0.01489956391058121],
    [ 0.2560046720818122, 3.738379858847606,-10.25803052150991,11.73970408392119,-1.965832605102681,
      0.3053195680701161,-35.13200601587556,1238.732680559852,35.14765318693473],
    [ 0.01532856961552287, 0.1296876459958492, -5.869778335825212, 4.144607847312670, -1.999697044584623,
     -29.36865667344516, 5.786781200597918, 63.58059663540046,-3.806468298143671],
])
HYPERGEOM_I = np.array([
    [ 0.6265483823527411,-0.8488996006421011,-2.430767712870059,-0.2216645603123820,-1.377915333154397,
     -0.01067779281977426,-1.106258117483859,-0.0008017018734870802,-1.025715949003203],
    [ 0.2556745290319481,-1.302202831061045,-1.856484357772605,-0.1506639551665747,-1.365766354550209,
     -0.008801806475184472,-1.097860353907581,-0.0006463098611572502,-1.023023211337991],
    [ 0.06793076058208223,-1.259938656832443,-1.383753616440758,-0.04811851897121551,-1.252578275690214,
     -0.004438147879886131,-1.071030099270125,-0.0003371916228163400,-1.016826439397124],
    [-0.1438872110578193,-1.318526106712988,-1.165709435421967,-0.01078909626071359,-1.140430116301888,
     -0.001811274363462059,-1.048091679713478,-0.0001577543940147300,-1.011553061701041],
    [-0.5623160680982770,-1.576021970674381,-1.076471896362168,-0.001780342522184680,-1.062427091799673,
      0.004018205261775791,-0.6514030690056149, 0.005561736279330680,-1.027642872383092],
    [-9.162872732083632, 42.14305648246658, 5.624924575599729, 2.272916747830027,-1.389775678893547,
     -0.00073079680223201,-1.034210205811073,-0.00008747485028171,-1.0085136703608],
    [ 0.2017739963700901, 0.5462246106199197, -5.109468125375064,14.41419452992633, 2.502624381778485,
     -0.0000680997442925,-1.030883958557467,-0.00008191929998314,-1.008456613288245],
    [ 0.3185170028368671, 0.8886260784862031, -3.580049820836553, 5.651162454123797, 1.186628617227599,
     -0.00003820523068188,-1.023368519956452,-0.00004924296499383,-1.006649542714069],
    [ 0.5045523625514224, 1.485758862452970, -2.752242779713227, 2.595936432732558, 0.4785798705675604,
     -0.00002433498096823,-1.019227289991061,-0.00003585972755995,-1.005789911366520],
    [ 1.398160625476730, 2.954532545810714, -2.136522020336696, 1.061026744232020, -0.06909753819383704,
     -0.00001821885545569,-1.015887980712423,-0.00002582418432982,-1.004995632391522],
    [ 3.620215546579624, 5.686835654840336, -1.799598166133843, 0.5134745736144935, -0.3602442057709179,
     -0.00001410577594344,-1.013913058391083,-0.00002176004393978,-1.004725750313438],
    [ 8.776955057607215,10.69299243000038, -1.596330222811836, 0.2810073271616607, -0.5309379037693800,
     -0.00001164458682589,-1.013280572890286,-0.00002307480563413,-1.005031422945444],
    [20.02358305143908,19.69122956965990, -1.465053947210626, 0.1693355984048097, -0.6378402328091336,
     -0.00001088292906364,-1.014557343074211,-0.00003173874282459,-1.005763792645454],
])
HYPERGEOM_1 = np.array([
    [  0.9360775742346216,-0.2250790790392765, 0.0348401207694437,-0.0422023273198643, 0.0104808433089421,
     -0.0230793977530508, 0.0049617494377955,-0.0158670859552224, 0.0028807359141383,-0.0120862568799546],
    [ 0.1430450323100617,-0.9003163161571056,0.02156517827104491,-0.8440465463972865,0.008039995073102123,
     -0.8308583191098289,0.004137595481807615,-0.8250884696715662,0.002509932082129108,-0.8218654678369117],
    [-2.819671260176213,-2.400843509752283,-2.866871055726074,-5.251845177583119,-2.875549627231282,
     -8.123948009073887,-2.878479952408139,-11.00117959562089,-2.879798366033066,-13.88039456791229],
    [-11.3768305631473,-5.76202442340548,-22.46842570169623,-22.68797116715908,-33.54140985134508,
     -50.69343557662106,-44.61066123524255,-89.76962550026647,-55.67872510000488,-139.914377244556],
    [-33.53009359531525,-13.17034153921252,-110.3361852693207,-81.49148827387747,-230.4962906372769,
     -248.2943783344704,-394.0183070924650,-556.9380847363468,-600.9038975602715,-1050.785527061154],
    [-87.51906383078700,-29.26742564269449,-434.6509534806616,-261.5776166815820,-1212.744309671997,
     -1042.223316465678,-2593.120194540037,-2887.827106040317,-4747.096184506519,-6486.330413957741],
    [-214.1711215952598,-63.85620140224254,-1500.709045078266,-778.2474545898310,-5397.230112323440,
     -3927.717622383053,-14120.94007905760,-13174.21952507649,-30568.64501900970,-34736.71163838528],
    [-503.6105492173122,-137.5364337894455,-4742.610771427904,-2191.986913519288,-21381.51289794725,
     -13665.66841397181,-67219.94462809997,-54567.77318079023,-169894.9790469529,-166900.6500021825],
    [-1152.612120663817,-293.4110587508170,-14062.58521759393,-5923.235748532118,-77715.55133278912,
     -44701.91978970333,-289167.5872258646,-209540.2490142344,-843996.0107326956,-735846.4213429555],
    [-2587.023565073958,-621.3410655899655,-39737.92516363194,-15494.69282314976,-264294.3690284689,
     -139210.1308329862,-1149012.999729593,-756955.0864043624,-3836087.008386949,-3024863.489811182],
    [-5721.752022023828,-1308.086453873611,-108138.6205048347,-39487.85982630963,-852386.5359668258,
     -416473.5216056094,-4282240.812990009,-2600067.332801687,-16217451.44075212,-11730772.53666386],
    [-12510.48091662534,-2740.752570020901,-285492.8478112217,-98495.79548512613,-2632527.346250018,
     -1205034.497888340,-15137019.29939817,-8560765.912081749,-64550174.40362200,-43305436.93806978],
    [-27103.58303477956,-5719.831450478403,-735179.4395018670,-241305.3893170576,-7842282.258628712,
     -3389586.640563044,-51179318.48413728,-27187309.51284942,-244144745.5117011,-153247217.2931317],
])
Q_PREFACTOR = np.array([
    2.221441469079183, 0.5553603672697958, 0.2082601377261734, 0.08677505738590559,
    0.03796408760633369, 0.01708383942285016, 0.007830093068806324, 0.003635400353374365,
    0.001704093915644234, 0.0008047110157208882, 0.0003822377324674218, 0.0001824316450412695,
    0.0000874151632489416
])
X_THRESHOLD1 = np.array([0.94,0.956,0.968,0.98,0.98,0.983,0.987,0.989,0.99,0.992,0.992,0.9928,0.993])
X_THRESHOLD0 = np.array([0.72,0.72,0.80,0.80,0.83,0.86,0.85,0.88,0.88,0.88,0.885,0.90,0.91])